name: C++ CI

on:
  push:
    branches: [ "main", "sem3.2" ]
  pull_request:
    branches: [ "main", "sem3.2" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up C++ environment
      run: |
        sudo apt-get update
        sudo apt-get install -y g++

    - name: Compile main program
      run: |
        g++ -o matrix_multiplier main.cpp -std=c++11
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞"

    - name: Compile test program
      run: |
        g++ -o test_program test.cpp -std=c++11
        echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞"

    - name: Run tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        ./test_program
        if [ $? -eq 0 ]; then
          echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"
        else
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏"
          exit 1
        fi

    - name: Test main program with sample input
      run: |
        echo "üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –ø—Ä–∏–º–µ—Ä–æ–º –≤–≤–æ–¥–∞..."
        # –°–æ–∑–¥–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        echo -e "2\n2\n1\n2\n3\n4\n5\n6\n7\n8" > test_input.txt
        ./matrix_multiplier < test_input.txt > output.txt
        echo "‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–≤–æ–¥–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã..."
        if grep -q "5 12" output.txt && grep -q "21 32" output.txt; then
          echo "‚úÖ –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
        else
          echo "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ output.txt:"
          cat output.txt
          exit 1
        fi

    - name: Test memory management with valgrind
      run: |
        echo "üß† –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é —Å –ø–æ–º–æ—â—å—é valgrind..."
        sudo apt-get install -y valgrind
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
        echo -e "2\n2\n1\n2\n3\n4\n5\n6\n7\n8" > test_input.txt
        valgrind --leak-check=full --error-exitcode=1 ./matrix_multiplier < test_input.txt
        if [ $? -eq 0 ]; then
          echo "‚úÖ –£—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        else
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏"
          exit 1
        fi

        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
        valgrind --leak-check=full --error-exitcode=1 ./test_program
        if [ $? -eq 0 ]; then
          echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç–∞–∫–∂–µ –Ω–µ –∏–º–µ–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏"
        else
          echo "‚ùå –í —Ç–µ—Å—Ç–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏"
          exit 1
        fi

    - name: Test with different inputs
      run: |
        echo "üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏..."

        # –¢–µ—Å—Ç 1: –ú–∞—Ç—Ä–∏—Ü–∞ 1x1
        echo -e "1\n1\n5\n10" | ./matrix_multiplier > output1.txt
        if grep -q "50" output1.txt; then
          echo "‚úÖ –¢–µ—Å—Ç 1x1 –ø—Ä–æ–π–¥–µ–Ω"
        else
          echo "‚ùå –¢–µ—Å—Ç 1x1 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω"
          exit 1
        fi

        # –¢–µ—Å—Ç 2: –ú–∞—Ç—Ä–∏—Ü–∞ 3x2
        echo -e "3\n2\n1\n2\n3\n4\n5\n6\n2\n3\n4\n5\n6\n7" | ./matrix_multiplier > output2.txt
        if grep -q "2 6" output2.txt && grep -q "12 20" output2.txt && grep -q "30 42" output2.txt; then
          echo "‚úÖ –¢–µ—Å—Ç 3x2 –ø—Ä–æ–π–¥–µ–Ω"
        else
          echo "‚ùå –¢–µ—Å—Ç 3x2 –Ω–µ –ø—Ä–æ–π–¥–µ–Ω"
          exit 1
        fi

    - name: Cleanup
      run: |
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
        rm -f matrix_multiplier test_program test_input.txt output.txt output1.txt output2.txt
        echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

    - name: Build status
      run: |
        echo "üéâ –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
        echo "   - –ö–æ–º–ø–∏–ª—è—Ü–∏—è: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
        echo "   - Unit-—Ç–µ—Å—Ç—ã: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
        echo "   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
        echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏: ‚úÖ –£—Å–ø–µ—à–Ω–æ"
